<!DOCTYPE html><html><head><script>var lastMsg,fmap,left,fls,gtime,timg,allowed=!1,dir=null,noThumbs=null,locStor={};function go(){console.log("deviceStorage");window.addEventListener("message",onMessage,!1);var e={req:window.indexedDB.open("deviceStorage")};e.req.onupgradeneeded=function(e){e.target.result.createObjectStore("rsrc",{keyPath:"k"})},e.req.onsuccess=function(e){(locStor.db=e.target.result).transaction(["rsrc"],"readwrite").objectStore("rsrc").get("fs0").onsuccess=function(e){e.target.result&&("1"==localStorage.getItem("forget")?localStorage.removeItem("forget"):(locStor.fset=e.target.result.fset,dir=locStor.fset))}},allowed=!1,send("ready",!1)}async function makeFolder(e){e=__getPath(e);for(var r=dir,t=0;t<e.length-1;t++)r=await r.getDirectoryHandle(e[t]);await r.getDirectoryHandle(e[e.length-1],{create:!0});send("0","")}async function deleteFile(e){e=__getPath(e);for(var r=dir,t=0;t<e.length-1;t++)r=await r.getDirectoryHandle(e[t]);await r.removeEntry(e[e.length-1],{recursive:!0}),send("0","")}async function saveFile(e,r){e=__getPath(e);for(var t=dir,a=0;a<e.length-1;a++)t=await t.getDirectoryHandle(e[a]);var n=await t.getFileHandle(e[e.length-1],{create:!0}),i=await n.createWritable();await i.write(r),await i.close(),send("0","")}async function printFile(e){e=__getPath(e);for(var r=dir,t=0;t<e.length-1;t++)r=await r.getDirectoryHandle(e[t]);var a=await r.getFileHandle(e[e.length-1]),n=await a.getFile(),i=await n.arrayBuffer();window.parent.postMessage(i,"*")}async function printFolder(e){e=__getPath(e);for(var r=dir,t=0;t<e.length;t++)r=await r.getDirectoryHandle(e[t]);fls=[],fmap={},left=0,timg=0,gtime=Date.now();Date.now();var a=!1;for await(var n of r.values()){var i=[n.name,-1];fls.push(i),"file"==n.kind&&(a=!0,fmap[n.name]=fls.length-1,left++,n.getFile().then(fileLoaded))}a||send("0",fls)}async function fileLoaded(e){file=fls[fmap[e.name]],await makeFile(e,file),0==--left&&(console.log(Date.now()-gtime,timg),send("0",fls))}async function makeFile(e,r){var t=e.name.split("."),a=(1==t.length?"":t.pop()).toLowerCase();r[1]=e.size,r.push(~~(e.lastModified/1e3)),"jpeg"==a&&(a="jpg"),"tiff"==a&&(a="tif"),-1!=["dng","cr2","nef","arw","3fr","fff","gpr"].indexOf(a)&&(a="tif"),noThumbs&&(a="---");var n=null;if(null==n&&("jpg"==a||"tif"==a)){var i=13e4,o=await e.slice(0,195e3>e.size?e.size:i).arrayBuffer();n="jpg"==a&&o.byteLength==e.size?bufToUrl(o,"jpg"):findJPG(e.name,o)}if(null==n&&("psd"==a||"psb"==a)){o=await e.slice(0,4096).arrayBuffer();var s=readUint(o=new Uint8Array(o),m=26);m+=4;var l=readUint(o,m+=s);for(o=(m+=4)+l<=4096?o.slice(m,m+l):new Uint8Array(await e.slice(m,m+l).arrayBuffer()),m=0;m<o.length;){readASCII(o,m,4);var f=readUshort(o,m+=4),d=o[m+=2],c=readUint(o,m+=d+(1-(1&d))+1);if(m+=4,1036==f){var u=readUint(o,m+20),g=m+28;n=bufToUrl(o.slice(g,g+u).buffer,"jpg");break}m+=c+(1&c)}}if(null==n&&e.size<1e5&&-1!=["png","svg","bmp","gif","webp"].indexOf(a)){o=await e.arrayBuffer();if("png"==a){for(var w=new Uint8Array(o),m=16,p=new Uint8Array(4),v=[],h=0;h<2;h++){for(var y=0;y<4;y++)p[y]=w[m+3-y];v.push(new Uint32Array(p.buffer)[0])}v[0]*v[1]<1e6&&(n=bufToUrl(o,a))}else n=bufToUrl(o,a)}n&&(r.push(n),timg++)}function findJPG(e,r){for(var t=-1,a=-1,n=(r=new Uint8Array(r)).length-1,i=[],o=2;o<n;o++)if(255==r[o]){var s=r[o+1],l=r[o+2];r[o+3];-1==t&&216==s&&255==l?t=o:-1!=t&&217==s&&(a=o,i.push(t,a),t=a=-1)}if(0!=i.length)return t=i[0],a=i[1],bufToUrl(r.slice(t,a+2).buffer,"jpg")}var u8=new Uint8Array(4),u16=new Uint16Array(u8.buffer),u32=new Uint32Array(u8.buffer);function readASCII(e,r,t){for(var a="",n=0;n<t;n++)a+=String.fromCharCode(e[r+n]);return a}function readUshort(e,r){return u8[0]=e[r+1],u8[1]=e[r],u16[0]}function readUint(e,r){return u8[0]=e[r+3],u8[1]=e[r+2],u8[2]=e[r+1],u8[3]=e[r],u32[0]}function bufToUrl(e,r){var t=[];e=new Uint8Array(e);for(var a=0;a<e.length;a++)t.push(String.fromCharCode(e[a]));return"data:image/"+r+("svg"==r?"+xml":"")+";base64,"+btoa(t.join(""))}async function askPermissions(){if(dir){if("granted"!=await dir.requestPermission({mode:"readwrite"}))return void send("1","You must give us access to some folder.")}else{try{dir=await window.showDirectoryPicker()}catch(e){return console.log(e),void send("1","You must give us access to some folder.")}locStor.fset=dir,locStor.db.transaction(["rsrc"],"readwrite").objectStore("rsrc").put({k:"fs0",fset:locStor.fset}).onerror=function(e){console.log(e),alert("Storing failed. Browser says: "+e.target.error.message,7e3)}}allowed=!0,printFolder("/")}function onMessage(e){if("string"==typeof e.data){if(null==window.showDirectoryPicker)return void send("1","Your browser can not perform this feature.");var r=null;try{r=JSON.parse(e.data)}catch(e){return}if(null==r.code)return;if(!allowed)return void askPermissions();"show"==r.code?(noThumbs=r.nothumbs,printFolder(r.prm)):"load"==r.code?printFile(r.prm):"delete"==r.code?deleteFile(r.prm):"save"==r.code&&r.prm.endsWith("/")?makeFolder(r.prm.slice(0,-1)):"forget"==r.code?(console.log("forget message"),localStorage.setItem("forget","1"),send("0","")):"rename"==r.code&&send("1","We can not rename files in your coputer yet."),lastMsg=r}else"save"==lastMsg.code&&saveFile(lastMsg.prm,e.data)}function __getPath(e){var r=[];return e.length>1&&(r=e.slice(1).split("/")),r}function send(e,r){Date.now();var t=JSON.stringify({code:e,prm:r});window.parent.postMessage(t,"*")}</script></head><body onload="go()"></body></html>
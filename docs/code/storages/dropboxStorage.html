<!DOCTYPE html><html><head><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/dropbox@10.9.0/dist/Dropbox-sdk.min.js"></script></head><body onload="go()"><script type="text/javascript">var lastMsg,authUrl,sentFalse=!1,authDone=!1,DROPBOX_APP_KEY="ylv5pcromn2df1o",redirectUri="https://www.photopea.com/code/storages/dropboxStorage.html",dbx=new Dropbox.Dropbox({clientId:DROPBOX_APP_KEY});function go(){"authwin"==window.name?(authDone=!1,window.setTimeout(function(){var e=new URLSearchParams(window.location.search.substr(1)).get("code");window.opener.saveCode(e),send("ready",!0),window.setTimeout(function(){window.close()},400)},100)):(dbx.auth.accessToken=localStorage.getItem("dropboxAccessToken"),window.addEventListener("message",onMessage,!1),doAction(checkUser))}function handleError(e){console.log(e),e.error&&"multiple_colons"==e.error?send(1,"Rename path contains more than one colon."):(send("ready",!1),sentFalse=!0)}function saveCode(e){dbx.auth.getAccessTokenFromCode(redirectUri,e).then(function({result:e}){dbx.auth.accessToken=e.access_token,localStorage.setItem("dropboxAccessToken",e.access_token),authDone=!0,retryAction?(doAction(retryAction.action,retryAction.prms,1),retryAction=null):send("ready",!0)}).catch(function(e){handleError(e)})}function signOut(){var e=window.open("https://www.dropbox.com/logout","logoutwin","width=700,height=800");e?(dbx.authTokenRevoke().then(function({result:e}){send(0,"")}).catch(function(e){handleError(e)}),window.setTimeout(function(){e.close()},5e3)):handleError("Popup window blocked.")}function doAction(e,n){e==signOut?signOut():sentFalse?authenticate(e,n):dbx.auth.accessToken?e(n):handleError("No Access Token present.")}function handleListResult(e,n,t){var o=e.result.entries;t||(t=[]);for(var r=0;r<o.length;++r)"file"==o[r][".tag"]?t.push([o[r].name,o[r].size,Date.parse(o[r].server_modified)/1e3]):t.push([o[r].name,-1,0]);e.result.has_more?(n.cursor=e.result.cursor,listDir(n,t)):getThumbnailPage(n,0,t)}function listDir(e,n){"/"==e.path&&(e.path=""),e.cursor?dbx.filesListFolderContinue({cursor:e.cursor}).then(function(t){handleListResult(t,e,n)}).catch(function(e){handleError(e)}):dbx.filesListFolder({path:e.path}).then(function(t){handleListResult(t,e,n)}).catch(function(e){handleError(e)})}function getThumbnailPage(e,n,t){for(var o=n,r=["jpg","jpeg","png","tiff","tif","gif","webp","ppm","bmp","JPG","JPEG","PNG","TIFF","TIF","GIF","WEBP","PPM","BMP"],a=[];a.length<25&&o<t.length;)r.includes(t[o][0].split(".").pop())&&a.push({path:e.path+"/"+t[o][0],format:"png"}),++o;dbx.filesGetThumbnailBatch({entries:a}).then(function(a){o=n;for(var i=0;i<25&&o<t.length;){var c=t[o][0].split(".");c.length>1&&r.includes(c.pop())&&(t[o].push(a.result.entries[i].thumbnail),++i),++o}o<t.length?getThumbnailPage(e,o,t):convertThumbnail(e,0,t)}).catch(function(e){console.log(e)})}function convertThumbnail(e,n,t){n==t.length?send(0,t):4==t[n].length?fetch("data:image/png;base64,"+t[n][3]).then(function(o){o.blob().then(function(o){t[n][3]=URL.createObjectURL(o),convertThumbnail(e,n+1,t)}).catch(function(e){handleError(e)})}).catch(function(e){handleError(e)}):convertThumbnail(e,n+1,t)}function downloadFile(e){dbx.filesDownload({path:e.path}).then(function(e){e.result.fileBlob.arrayBuffer().then(function(e){window.parent.postMessage(e,"*")}).catch(function(e){handleError(e)})}).catch(function(e){handleError(e)})}function downloadThumbnail(e){dbx.filesGetThumbnail({path:e.path,format:"png"}).then(function(e){var n=URL.createObjectURL(e.result.fileBlob);console.log(n);var t=new XMLHttpRequest;t.open("GET",n,!0),t.responseType="arraybuffer",t.onload=function(e){window.parent.postMessage(e.target.response,"*")},t.onerror=function(e){console.error(e)},t.send()}).catch(function(e){handleError(e)})}function uploadFile(e){var n=new Blob([e.buffer]);dbx.filesUpload({path:e.path,contents:n,mode:"overwrite"}).then(function(e){send(0,"")}).catch(function(e){send(1,e)})}function deleteFile(e){dbx.filesDelete({path:e.path}).then(function(e){send(0,"")}).catch(function(e){send(1,e)})}function makeFolder(e){dbx.filesCreateFolderV2({path:e.path.slice(0,-1)}).then(function(e){send(0,"")}).catch(function(e){send(1,e)})}function renameFile(e){dbx.filesMoveV2({from_path:e.from_path,to_path:e.to_path}).then(function(e){send(0,"")}).catch(function(e){send(1,e)})}function authenticate(e,n){sentFalse=!1,e&&(retryAction={action:e,prms:n}),dbx.auth.getAuthenticationUrl(redirectUri,"","code","",["account_info.read","files.content.write","files.content.read"],"user",!0).then(function(e){var n=window.open(e,"authwin","width=700,height=800");if(n)var t=setInterval(function(){n.closed&&(clearInterval(t),authDone||handleError("Authorization failed (window closed without authorization completing."))},500);else handleError("Popup window blocked.")})}function checkUser(e){send("ready",!0)}function onMessage(e){if("string"==typeof e.data){var n=JSON.parse(e.data);if(console.log(n),"show"==n.code)doAction(listDir,{path:n.prm});else if("load"==n.code)doAction(downloadFile,{path:n.prm});else if("delete"==n.code)doAction(deleteFile,{path:n.prm});else if("save"==n.code&&n.prm.endsWith("/"))doAction(makeFolder,{path:n.prm});else if("forget"==n.code)doAction(signOut);else if("rename"==n.code){var t=n.prm.split(":");if(t.length>2)return void handleError({error:"multiple_colons"});doAction(renameFile,{from_path:t[0],to_path:t[0].substring(0,t[0].lastIndexOf("/")+1)+t[1]})}lastMsg=n}else"save"==lastMsg.code&&doAction(uploadFile,{path:lastMsg.prm,buffer:e.data})}function send(e,n){window.parent.postMessage(JSON.stringify({code:e,prm:n}),"*")}</script></body></html>
<!DOCTYPE html><html><head><script type="text/javascript" src="https://apis.google.com/js/api.js"></script><script src="https://accounts.google.com/gsi/client" async defer="defer"></script></head><body onload="go()"><script type="text/javascript">var tmpAction,tmpPrms,client,sentFalse=!1,refreshToken=!1,clientId="463342976776-04ub3ijsr7i5qobn8ha32ap6vsaae75a.apps.googleusercontent.com",scope="https://www.googleapis.com/auth/drive",discoveryDocs="https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",mode3dir="Photopea",sharedDrives=null,mode=0;function go(){var e=window.location.search,o=new URLSearchParams(e);o.get("mode")&&(mode=o.get("mode")),scope=2==mode?"https://www.googleapis.com/auth/drive.appdata":"https://www.googleapis.com/auth/drive.file",window.addEventListener("message",onMessage,!1),gapi.load("client",gapiInit)}function saveToken(e){2==mode?(localStorage.setItem("googledriveAppFolderAccessToken",e.access_token),localStorage.setItem("googledriveAppFolderAccessTokenValidUntil",Date.now()+1e3*e.expires_in)):3==mode?(localStorage.setItem("googledriveFileAccessToken",e.access_token),localStorage.setItem("googledriveFileAccessTokenValidUntil",Date.now()+1e3*e.expires_in)):(localStorage.setItem("googledriveAccessToken",e.access_token),localStorage.setItem("googledriveAccessTokenValidUntil",Date.now()+1e3*e.expires_in)),refreshToken?(refreshToken=!1,doAction(tmpAction,tmpPrms)):send("ready",!0)}function gapiInit(){gapi.client.init({}).then(function(){gapi.client.load(discoveryDocs).then(function(){if(client=google.accounts.oauth2.initTokenClient({client_id:clientId,scope:scope,callback:saveToken}),2==mode){if(Date.now()<localStorage.getItem("googledriveAppFolderAccessTokenValidUntil"))return gapi.client.setToken({access_token:localStorage.getItem("googledriveAppFolderAccessToken")}),void send("ready",!0)}else if(3==mode&&Date.now()<localStorage.getItem("googledriveFileAccessTokenValidUntil"))return gapi.client.setToken({access_token:localStorage.getItem("googledriveFileAccessToken")}),void send("ready",!0);Date.now()<localStorage.getItem("googledriveAccessTokenValidUntil")?(gapi.client.setToken({access_token:localStorage.getItem("googledriveAccessToken")}),send("ready",!0)):(send("ready",!1),sentFalse=!0)}).catch(function(e){handleError(e)})}).catch(function(e){handleError(e)})}function handleError(e){console.log(e),e.result&&e.result.error&&e.result.error.code?(403==e.result.error.code&&(send("ready",!1),sentFalse=!0),401==e.result.error.code&&(send("ready",!1),sentFalse=!0)):e.error&&("access_denied"==e.error&&(send("ready",!1),sentFalse=!0),"popup_closed_by_user"==e.error&&(send("ready",!1),sentFalse=!0),"popup_blocked_by_browser"==e.error&&(send("ready",!1),sentFalse=!0),"multiple_colons"==e.error&&send(1,"Rename path contains more than one colon."))}function authorize(e,o){sentFalse?sentFalse=!1:(refreshToken=!0,tmpAction=e,tmpPrms=o),client.requestAccessToken()}function getSharedDriveId(e){for(var o=0;o<sharedDrives.length;++o)if(sharedDrives[o].name==e)return sharedDrives[o].id;return null}function findFile(e,o,t,n,r){if(!t)if(0==mode)t="root";else if(3==mode){if(2==o.length&&""==o[1])return void checkFile("root",o[0],null,null);t="root"}else if(2==mode)t="appDataFolder";else if(4==mode)t="sharedWithMe";else{if(1==o.length&&""==o[0])return void listDrives(null,[]);t=getSharedDriveId(o[0]),o=o.slice(1)}if(t)if(0!=o.length&&""!=o[0])if(1!=o.length||e!=createDir)if(1!=o.length||e!=checkFile){var i=null;if(1==o.length&&e==renameFile){var s=o[0].split(":");if(s.length>2)return void handleError({error:"multiple_colons"});o[0]=s[0],i=s[1]}var a,l={q:a="'"+t+"' in parents",pageToken:n,pageSize:1e3,fields:"nextPageToken, files(id, name, size, modifiedTime, kind, mimeType, trashed, shortcutDetails)"};1==mode||"'root' in parents"!=a?(l.supportsAllDrives=!0,l.includeItemsFromAllDrives=!0):2==mode&&(l.spaces="appDataFolder"),4==mode&&"'sharedWithMe' in parents"==l.q&&(l.q="sharedWithMe"),gapi.client.drive.files.list(l).then(function(s){var a=s.result.files;n=s.result.nextPageToken;for(var l=!1,d=0;d<a.length;++d)if(!a[d].trashed&&a[d].name==o[0])return l=!0,i&&e==renameFile?void renameFile(a[d].id,i):a[d].shortcutDetails?void findFile(e,o.slice(1),a[d].shortcutDetails.targetId,null,r):void findFile(e,o.slice(1),a[d].id,null,r);!l&&n?findFile(e,o,t,n,r):e==checkFile?i(t,o[0],r):e==renameFile&&(handleError("Could not find file to rename '"+o[0]+"'"),send(1,"Could not find file to rename '"+o[0]+"'"))}).catch(handleError)}else e(t,o[0],null,r);else e(t,o[0]);else e==listDir?e(null,a="'"+t+"' in parents",[]):e(t);else handleError({error:"no_id"})}function listDrives(e,o){gapi.client.drive.drives.list({pageToken:e,pageSize:50,fields:"nextPageToken, drives(id, name, createdTime)"}).then(function(t){var n=t.result.drives;sharedDrives=t.result.drives,e=t.result.nextPageToken;for(var r=0;r<n.length;++r)o.push([n[r].name,-1,Math.round(Date.parse(n[r].createdTime)/1e3)]);e?listDrives(e,o):send(0,o)}).catch(handleError)}function listDir(e,o,t){var n={q:o,pageToken:e,pageSize:1e3,fields:"nextPageToken, files(id, name, size, modifiedTime, kind, mimeType, thumbnailLink, trashed, shortcutDetails)"};1==mode||"'root' in parents"!=o?(n.supportsAllDrives=!0,n.includeItemsFromAllDrives=!0):2==mode&&(n.spaces="appDataFolder"),4==mode&&"'sharedWithMe' in parents"==n.q&&(n.q="sharedWithMe"),gapi.client.drive.files.list(n).then(function(n){var r=n.result.files;e=n.result.nextPageToken;for(var i=0;i<r.length;++i)r[i].trashed||("application/vnd.google-apps.folder"==r[i].mimeType?t.push([r[i].name,-1,Math.round(Date.parse(r[i].modifiedTime)/1e3)]):"application/vnd.google-apps.shortcut"==r[i].mimeType?"application/vnd.google-apps.folder"==r[i].shortcutDetails.targetMimeType?t.push([r[i].name,-1,Math.round(Date.parse(r[i].modifiedTime)/1e3)]):"application/vnd.google-apps"==r[i].shortcutDetails.targetMimeType||(r[i].thumbnailLink?t.push([r[i].name,0,Math.round(Date.parse(r[i].modifiedTime)/1e3),r[i].thumbnailLink]):t.push([r[i].name,0,Math.round(Date.parse(r[i].modifiedTime)/1e3)])):r[i].mimeType.includes("application/vnd.google-apps.")||(r[i].thumbnailLink?t.push([r[i].name,r[i].size?parseInt(r[i].size):0,Math.round(Date.parse(r[i].modifiedTime)/1e3),r[i].thumbnailLink]):t.push([r[i].name,parseInt(r[i].size),Math.round(Date.parse(r[i].modifiedTime)/1e3)])));e?listDir(e,o,t):send(0,t)}).catch(handleError)}function downloadFile(e){var o=new XMLHttpRequest;o.open("GET","https://www.googleapis.com/drive/v3/files/"+e+"?alt=media&supportsAllDrives=true"),o.responseType="arraybuffer",o.setRequestHeader("Authorization","Bearer "+gapi.client.getToken().access_token),o.onload=function(e){window.parent.postMessage(e.target.response,"*")},o.onerror=function(e){console.error(e)},o.send()}function downloadThumbnail(e){var o=new XMLHttpRequest;o.open("GET","https://www.googleapis.com/drive/v3/files/"+e+"?fields=thumbnailLink&supportsAllDrives=true"),o.setRequestHeader("Authorization","Bearer "+gapi.client.getToken().access_token),o.onload=function(e){var o=JSON.parse(e.target.response).thumbnailLink;if(console.log(JSON.parse(e.target.response)),o){var t=new XMLHttpRequest;t.open("GET",o),t.responseType="arraybuffer",t.onload=function(e){window.parent.postMessage(e.target.response,"*")},t.onerror=function(e){console.error(e)},t.send()}else console.error("Could not get thumbnailLink.")},o.onerror=function(e){console.error(e)},o.send()}function deleteFile(e){if(1!=mode){var o={fileId:e};gapi.client.drive.files.delete(o).then(function(e){send(0,"")}).catch(function(e){send(1,e),handleError(e)})}else trashFile(e)}function trashFile(e){var o={fileId:e,resource:{trashed:!0}};1==mode&&(o.supportsAllDrives=!0),gapi.client.drive.files.update(o).then(function(e){send(0,"")}).catch(function(e){send(1,e),handleError(e)})}function createDir(e,o){var t={resource:{name:o,parents:[e],mimeType:"application/vnd.google-apps.folder"}};1==mode&&(t.supportsAllDrives=!0),gapi.client.drive.files.create(t).then(function(e){e.result.name!=mode3dir?send(0,""):listDir(null,"'"+e.result.id+"' in parents",[])}).catch(function(e){send(1,e),handleError(e)})}function renameFile(e,o){var t={fileId:e,resource:{name:o},supportsAllDrives:!0};gapi.client.drive.files.update(t).then(function(e){send(0,"")}).catch(function(e){send(1,e),handleError(e)})}function checkFile(e,o,t,n){var r="'"+e+"' in parents",i={q:r,pageToken:t,pageSize:1e3,fields:"nextPageToken, files(id, name, trashed, mimeType, shortcutDetails)"};1==mode?(i.supportsAllDrives=!0,i.includeItemsFromAllDrives=!0):2==mode&&(i.spaces="appDataFolder"),gapi.client.drive.files.list(i).then(function(i){var s=i.result.files;t=i.result.nextPageToken;for(var a=!1,l=0;l<s.length;++l)if(!s[l].trashed&&s[l].name==o){a=!0;var d=s[l].id;return"application/vnd.google-apps.shortcut"==s[l].mimeType&&(d=s[l].shortcutDetails.targetId),void(n?uploadFile(d,e,o,n):listDir(null,r="'"+d+"' in parents",[]))}!a&&t?checkFile(e,o,t,n):n?uploadFile(null,e,o,n):createDir("root",o)}).catch(handleError)}function uploadFile(e,o,t,n){var r=new Blob([n]),i={name:t};e||(i.parents=[o]);var s=new XMLHttpRequest;if(n.byteLength>5e6){var a=r.type||"application/octet-stream";i.mimeType=a,i["Content-Type"]=a,i["Content-Length"]=r.size;var l="&supportsAllDrives=true";e?s.open("PATCH","https://www.googleapis.com/upload/drive/v3/files/"+e+"?uploadType=resumable"+l):s.open("POST","https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable"+l),s.setRequestHeader("Authorization","Bearer "+gapi.client.getToken().access_token),s.setRequestHeader("Content-Type","application/json"),s.setRequestHeader("X-Upload-Content-Length",r.size),s.setRequestHeader("X-Upload-Content-Type",a),s.onreadystatechange=function(){if(s.readyState===XMLHttpRequest.DONE&&200===s.status){var e=s.getResponseHeader("Location"),o=new FileReader;o.onload=function(t){var n=new XMLHttpRequest;n.open("PUT",e,!0),n.setRequestHeader("Content-Type",a),n.setRequestHeader("X-Upload-Content-Type",a),n.onreadystatechange=function(){n.readyState===XMLHttpRequest.DONE&&200===n.status&&send(0,"")},n.onerror=function(e){send(1,e),handleError(e)},n.send(o.result)},o.readAsArrayBuffer(r)}},s.onerror=function(e){send(1,e),handleError(e)},s.send(JSON.stringify(i))}else{var d=new FormData;d.append("metadata",new Blob([JSON.stringify(i)],{type:"application/json"})),d.append("file",r),l="&supportsAllDrives=true",e?s.open("PATCH","https://www.googleapis.com/upload/drive/v3/files/"+e+"?uploadType=multipart&fields=id"+l):s.open("POST","https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id"+l),s.setRequestHeader("Authorization","Bearer "+gapi.client.getToken().access_token),s.onload=function(e){send(0,"")},s.onerror=function(e){send(1,e),handleError(e)},s.send(d)}}function signOutUser(){2==mode&&(localStorage.removeItem("googledriveAppFolderAccessToken"),localStorage.removeItem("googledriveAppFolderAccessTokenValidUntil")),3==mode?(localStorage.removeItem("googledriveFileAccessToken"),localStorage.removeItem("googledriveFileAccessTokenValidUntil")):(localStorage.removeItem("googledriveAccessToken"),localStorage.removeItem("googledriveAccessTokenValidUntil")),gapi.client.setToken(""),send("ready",!1);var e=gapi.client.getToken();null!==e&&(google.accounts.oauth2.revoke(e.access_token,()=>{console.log("Revoked: "+e.access_token)}),gapi.client.setToken(""))}function checkToken(){var e;return!!((e=2==mode?localStorage.getItem("googledriveAppFolderAccessTokenValidUntil"):3==mode?localStorage.getItem("googledriveFileAccessTokenValidUntil"):localStorage.getItem("googledriveAccessTokenValidUntil"))&&Date.now()<e)}function doAction(e,o){e==signOutUser?signOutUser():checkToken()?sentFalse?authorize(e,o):gapi.client.getToken()?findFile(e,o.path.slice(1).split("/"),null,null,o.buffer):(send("ready",!1),sentFalse=!0):authorize(e,o)}function onMessage(e){if(!e.origin||"https://accounts.google.com"!=e.origin&&"https://content.googleapis.com"!=e.origin)if("string"==typeof e.data){var o=JSON.parse(e.data);3==mode&&"forget"!=o.code&&(o.prm="/"+mode3dir+o.prm),console.log(o),"show"==o.code?doAction(listDir,{path:o.prm}):"load"==o.code?doAction(downloadFile,{path:o.prm}):"delete"==o.code?doAction(deleteFile,{path:o.prm}):"save"==o.code&&o.prm.endsWith("/")?doAction(createDir,{path:o.prm.slice(0,-1)}):"rename"==o.code?doAction(renameFile,{path:o.prm}):"forget"==o.code&&doAction(signOutUser),lastMsg=o}else"save"==lastMsg.code&&doAction(checkFile,{path:lastMsg.prm,buffer:e.data})}function send(e,o){window.parent.postMessage(JSON.stringify({code:e,prm:o}),"*")}</script></body></html>